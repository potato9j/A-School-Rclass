# 16강. R데이터 핸들링1 (p.223~)

<br>

## 16-1 🟦 dplyr 패키지 함수 (p.223)

기호 | 사용법 | 의미  
:---: | --- | --- 
filter() | filter(데이터, 조건) | 조건에 맞는 행을 출력한다.
select() | select(데이터, 조건) |조건에 맞는 열을 출력한다.
arrange() | - |데이터를 정방향으로 정렬한다.
desc() | - | 데이터를 역방향으로 정렬한다.
mutate() | mutate(데이터, 새변수명 = 새변수생성규칙) |새로운 변수 생성
summarise() | summarise(요약변수명1 = 요약함수1, 요약변수명2 = 요약함수2, ...) | 분할된 데이터를 요약하고 다시 합침
group_by() | group_by(변수명1, 변수명2, ...) | 데이터를 집단별로 나눔
%>% | - | (명칭 : 파이프) 이전 함수에 이어 다음 함수까지 실행

<br>
<br>

------------------------------------------------------------------------------------------ 

## 16-1-1 🟦 summarise() 요약 통계량 함수 (p.236)

기호 | 의미  
:---: | --- 
mean() | 평균
median() | 중앙값
sd() | 표준편자(Standard Deviation)
min() | 최솟값
max() | 최댓값
IQR() | 사분위수(Inter Quartile Range)
sum() | 합
n() | 빈도(사례 수 세는 함수)
n_distinict() | 중복 제거 후 사례 수

<br>
<br>

------------------------------------------------------------------------------------------ 

## 16-1-2 🟦 dplyr 패키지 예시

<br>

```
   > iris
   > str(iris) #데이터 구조보기
   > View(iris)
   > table(iris$Species) #범주별 빈도

   > library(dplyr)
```
<br>

### **✅10/31 수업**

```
🔸 filter 함수 : filter(데이터, 조건), 행을 추출
   

🔹예제1
  Species 라는 변수가 "setosa"인 경우만 추출

   > filter(iris, Species == "setosa")  

   > iris %>%
      filter(Species == "setosa")
__________________________________________________________________________________________ 

🔹예제2
   Species 라는 변수가 "setosa"이고 Sepal.Width가 3이상인 데이터 추출
     
   > iris %>%
      filter(Species == "setosa" & Sepal.Width >= 3)
__________________________________________________________________________________________

🔹예제3
   Species 라는 변수가 "setosa"이고 Sepal.Width가 3이상인 데이터 중에 
   Sepal.Width와 Sepal.Length를 추출
   
   > iris %>%
      filter(Species == "setosa" & Sepal.Width >= 3) %>%
      select(Sepal.Width, Sepal.Length)
__________________________________________________________________________________________

🔹예제4
   Species 라는 변수가 "setosa"이고 Sepal.Width가 3이상인 데이터 중에 
   Sepal.Width와 Sepal.Length를 추출하고
   Sepal.Width의 내림차순, Sepal.Length는 오름차순으로 정렬   
   
   > iris %>%
      filter(Species == "setosa" & Sepal.Width >= 3) %>%
      select(Sepal.Width, Sepal.Length) %>%
      arrange(desc(Sepal.Width), Sepal.Length)

```      


```
🔸 mutate() : 새로운 변수 생성
🔸 mutate(데이터, 새변수명 = 새변수생성규칙)
__________________________________________________________________________________________

🔹예제1
   Species 라는 변수가 "setosa"이고 Sepal.Width가 3이상인 데이터 중에 
   Sepal.Width와 Sepal.Length를 추출하고 
   Sepal.Width의 내림차순, Sepal.Length는 오름차순으로 정렬하고 
   Sepal.Width와 Sepal.Length의 합을 Sepal이라는 변수로 저장
   
   > iris %>%
      filter(Species == "setosa" & Sepal.Width >= 3) %>%
      select(Sepal.Width, Sepal.Length) %>%
      arrange(desc(Sepal.Width), Sepal.Length) %>%
      mutate(Sepal = Sepal.Width+Sepal.Length)
__________________________________________________________________________________________

🔹예제2
   Species 라는 변수가 "setosa"이고 Sepal.Width가 3이상인 데이터 중에 
   Sepal.Width와 Sepal.Length를 추출하고 
   Sepal.Width의 내림차순, Sepal.Length는 오름차순으로 정렬하고 
   Sepal.Width와 Sepal.Length의 합을 Sepal이라는 변수로 저장, 
   mean_Septal.Length 변수에 Sepal.Length의 평균을 저장

   > iris %>%
      filter(Species == "setosa" & Sepal.Width >= 3) %>%
      select(Sepal.Width, Sepal.Length) %>%
      arrange(desc(Sepal.Width), Sepal.Length) %>%
      mutate(Sepal = Sepal.Width+Sepal.Length) %>%
      mutate(mean_Septal.Length = mean(Sepal.Length))
```


```
🔸 group_by() : 데이터를 분할
🔸 group_by(변수명1, 변수명2, ...) : 변수의 값 종류에 따라 데이터를 분할

🔸 summarise() : 분할된 데이터를 요약하고 다시 합침
🔸 summarise(요약변수명1 = 요약함수1, 요약변수명2 = 요약함수2, ...)
__________________________________________________________________________________________

🔹예제1
   iris 데이터에서 Species 범주별로 Sepal.Length의 평균, 
   Sepal.Width의 최대값, Petal.Length의 최소값, Petal.Width의 사례 수

   > iris %>%
      group_by(Species) %>%
      summarise(mean_Sepal.Length = mean(Sepal.Length), 
                max_Sepal.Width = max(Sepal.Width), 
                min_Petal.Length = min(Petal.Length), 
                num_Petal.Width = n())  #summarise의 n()함수는 사례 수 계산함수

```


```
🔹gapminder package를 설치 후 불러오고, gapminder 데이터의 구조보기
 
   > install.packages('gapminder')
   > library(gapminder)
   > library(dplyr)
   > str(gapminder)
__________________________________________________________________________________________

🔹연습문제1
   na.omit() 함수로 결측을 제거하고 
   아프리카 대륙에 있는 국가별 lifeExp의 평균, lifeExp의 최대, pop의 합을 구한 뒤 
   country이름의 오름차순으로 정렬

   > na.omit(gapminder) %>%
       filter(continent == "Africa") %>%
       group_by(country) %>%
       summarise(mean_lifeExp=mean(lifeExp), 
                 max_lifeExp=max(lifeExp),
                 sum_pop=sum(pop)) %>%
       arrange(country)
__________________________________________________________________________________________

🔹연습문제2
   airquality 데이터 셋을 이용해서 결측을 제거하고
   Month 별로 Ozone의 평균, Solar.R의 최대값, Wind의 중앙값(중위수)를 계산하고 
   Month 의 오름차순, Ozone의 평균의 내림차순으로 정렬

   > na.omit(airquality) %>%
       group_by(Month) %>%
       summarise(mean_Ozone=mean(Ozone), 
                 max_Solar.R=max(Solar.R),
                 median_Wind=median(Wind)) %>%
       arrange(Month, desc(mean_Ozone))
```
<br>

### **✅11/3 수업**
```
🔹데이터 파일 읽기
   > mtcars  #내장 데이터(R이 가지고 있는 데이터)
   > str(mtcars)  #데이터 구조 보기기
   > View(mtcars)  #표 형태로 보기

   > install.packages('dplyr')  #패키지 설치
   > library(dplyr)  #패키지 불러오기
__________________________________________________________________________________________

🔹예제1
   평균 연비 이상은 '고연비', 나머지는 '저연비' 로 저장하는 '연비'라는 변수생성
   
   방법1))
   > ifelse(mtcars$mpg >= mean(mtcars$mpg), '고연비', '저연비')

   방법2))
   > mtcars %>% 
       mutate(연비=ifelse(mpg >= mean(mpg), '고연비', '저연비'))
__________________________________________________________________________________________

🔹예제2
   평균 연비 이상은 '고연비', 나머지는 '저연비' 로 저장하는 '연비'라는
   변수생성하고 연비에 따른(연비종류 별로) cyl의 평균, 최대, 최소를 요약

   > mtcars %>% 
       mutate(연비=ifelse(mpg >= mean(mpg), '고연비', '저연비')) %>%
       group_by(연비) %>%
       summarise(평균cyl = mean(cyl), 
                 최대cyl = max(cyl),
                 최소cyl = min(cyl))
```

<br>

### **✅11/7 수업**
```
   > enrollment <- read.csv("c:/data/enrollment.csv")
   > library(dplyr)

   > str(enrollment)  #데이터구조보기
   > View(enrollment)  #테이블 형식으로 파일 보기
   > summary(enrollment)  #파일 내용 요약
__________________________________________________________________________________________

🔹취득학점에 따른 점수 계산 (A+ => 4.5)
   > ifelse(enrollment$성적 == 'A+', 4.5, 
            ifelse(enrollment$성적 == 'Ao', 4.0, 
                   ifelse(enrollment$성적 == 'B+', 3.5,
                          ifelse(enrollment$성적 == 'Bo', 3.0,
                                 ifelse(enrollment$성적 == 'C+', 2.5,
                                        ifelse(enrollment$성적 =='Co', 2.0, 0))))))
__________________________________________________________________________________________

🔹dplyr를 통한 변수생성

   > enrollment %>%
       mutate(성적점수 = ifelse(성적 == 'A+', 4.5, 
                         ifelse(성적 == 'Ao', 4.0, 
                         ifelse(성적 == 'B+', 3.5,
                         ifelse(성적 == 'Bo', 3.0,
                         ifelse(성적 == 'C+', 2.5,
                         ifelse(성적 == 'Co', 2.0, 0))))))) %>%
       mutate(학점수X성적점수 = 학점수*성적점수) %>%
       group_by(학번 ) %>%
       summarise(성적점수합 = sum(학점수X성적점수),
                 학점수합 = sum(학점수)) %>%
       mutate(GPA = 성적점수합/학점수합) %>%
       select(학번, GPA) %>% 
       merge(enrollment, by='학번', all.x=TRUE) %>%
       select(학번, GPA, 소속학과, 학년) %>%
       write.csv("C:/data/GPA.csv")
  ```



<br>

------------------------------------------------------------------------------------------ 

## 16-2 🟦 website자료 스크래핑 예시

<br>

### **✅ 11/14 수업 (주가스크래핑하기1)**

```
   > https://finance.naver.com/item/main.naver?code=005930

   > url1 <- 'https://finance.naver.com/item/main.naver?code='
   > movie_code <- '005930'
   > url <- paste(url1, movie_code, sep='')
   > url

   > html <- url %>%
       read_html(encoding='euc-kr')  #html 내용 가져오기


🔹삼성전자 주가 가져오기
   > stock_price <- html %>%
       html_node("div.rate_info > div.today > p.no_today > em.no_down") %>%   #tag정보 가져오기 / . : R에서는 CLASS를 의미
       html_text()  #tag 사이의 글자 추출
   > stock_price

   > stock_price <- gsub("(\\r|\\n|\\t)", "", stock_price)  #찾기, 바꾸기 / 줄바꿈 문자, 탭 제거
   > stock_price

   > stock_price <-substr(stock_price, 1, nchar(stock_price)/2)  #첫글자에서 중간까지 잘라냄
   > stock_price
   > stock_price <- gsub(",", "", stock_price) 
   > stock_price <- as.numeric(stock_price)  #숫자화
   > stock_price
  ```

<br>

### **✅ 11/15 수업 (주가 스크래핑하기2)**

```
🔹필요 패키지 설치 및 불러오기 
   > if(!require(devtools)) {install.packages("devtools"); library(devtools)} 
   > # if(!require(RSelenium)) {install.packages("RSelenium"); library(RSelenium)} 
   > if(!require(rvest)) {install.packages("rvest"); library(rvest)} 
   > if(!require(httr)) {install.packages("httr"); library(httr)} 
   > if(!require(stringr)) {install.packages("stringr"); library(stringr)} 
   > if(!require(dplyr)) {install.packages("dplyr"); library(dplyr)} 
__________________________________________________________________________________________

🔹url 생성
   > url1 <- 'https://finance.naver.com/item/main.naver?code='
   > stock_code <- '005930'
   > url <- paste(url1, stock_code, sep='')

   > html <- url %>%
       read_html(encoding = 'euc-kr')
   > html


🔹주식가격 가져오기
   > stock_price <- html %>%
       html_node("p.no_today") %>% 
       html_text()
   > stock_price
   > stock_price <- gsub("(\\r|\\n|\\t)", "", stock_price)
   > stock_price
   > stock_price <- gsub(",", "", stock_price)
   > stock_price
   > stock_price <-substr(stock_price, 1, nchar(stock_price)/2)
   > stock_price
   > stock_price <- as.numeric(stock_price)
   > stock_price
```

<br>

### **✅ 11/21 수업 (영화리뷰 스크래핑하기1)**

```
# 1 page 내용 가져오기

🔹url 생성
   > url1 <- 'https://movie.naver.com/movie/bi/mi/pointWriteFormList.naver?code='
   > url2 <- '&type=after&isActualPointWriteExecute=false&isMileageSubscriptionAlready=false&isMileageSubscriptionReject=false&page='
   > movie_code <- 93756

   > i <- 1

   > url <- paste(url1, movie_code, url2, i, sep='')  #url1, 2 합침
   > url


🔹html 읽기
   > html <- url %>%
       read_html()

   > star_score <- html %>%
       html_nodes('div.score_result > ul > li > div.star_score') %>%
       html_text()
   > star_score
   > star_score <- as.numeric(star_score)
   > star_score


   > review_contents <- html %>%
       html_nodes('div.score_reple > p') %>%
       html_text()
   > review_contents
   > review_contents <- gsub("(\\r|\\n|\\t)", "", review_contents)
   > review_contents


   > sympathy_count <- html %>%
       html_nodes('a._sympathyButton') %>%
       html_text()
   > sympathy_count
   > sympathy_count <- gsub("(\\r|\\n|\\t)", "", sympathy_count)
   > sympathy_count
   > sympathy_count <- gsub("공감", "", sympathy_count)
   > sympathy_count
   > sympathy_count <- as.numeric(sympathy_count)
   > sympathy_count


   > unsympathy_count <- html %>%
       html_nodes('a._notSympathyButton') %>%
       html_text()
   > unsympathy_count
   > unsympathy_count <- gsub("(\\r|\\n|\\t)", "", unsympathy_count)
   > unsympathy_count
   > unsympathy_count <- gsub("비공감", "", unsympathy_count)
   > unsympathy_count
   > unsympathy_count <- as.numeric(unsympathy_count)
   > unsympathy_count
```

<br>

### **✅ 11/22 수업 (영화리뷰 스크래핑하기2)**

```
🔹필요 패키지 설치 및 불러오기 
   > if(!require(devtools)) {install.packages("devtools"); library(devtools)} 
   > # if(!require(RSelenium)) {install.packages("RSelenium"); library(RSelenium)} 
   > if(!require(rvest)) {install.packages("rvest"); library(rvest)} 
   > if(!require(httr)) {install.packages("httr"); library(httr)} 
   > if(!require(stringr)) {install.packages("stringr"); library(stringr)} 
   > if(!require(dplyr)) {install.packages("dplyr"); library(dplyr)} 
__________________________________________________________________________________________

🔹url 생성
   > url1 <- 'https://movie.naver.com/movie/bi/mi/basic.nhn?code='
   > movie_code <- 93756
   > url <- paste(url1, movie_code, sep='')

   > html <- url %>%
       read_html()


🔹영화줄거리 가져오기
   > movie_story <- html %>%
       html_node("div.story_area > p.con_tx") %>% 
       html_text()
   > movie_story
```

<br>

### **✅ 11/28 수업 (신문기사 스크래핑하기)**

```
🔹필요 패키지 설치 및 불러오기 
   > if(!require(devtools)) {install.packages("devtools"); library(devtools)} 
   > # if(!require(RSelenium)) {install.packages("RSelenium"); library(RSelenium)} 
   > if(!require(rvest)) {install.packages("rvest"); library(rvest)} 
   > if(!require(httr)) {install.packages("httr"); library(httr)} 
   > if(!require(stringr)) {install.packages("stringr"); library(stringr)} 
   > if(!require(dplyr)) {install.packages("dplyr"); library(dplyr)} 
__________________________________________________________________________________________

   > url <- 'https://news.naver.com/main/ranking/popularDay.naver'

   > html <- url %>%
       read_html()


🔹언론사 이름 가져오기
   > media_name <- html %>%
       html_nodes('strong.rankingnews_name') %>%
       html_text()
   > media_name

🔹언론사 뉴스 제목 가져오기
   > news_title <- html %>%
       html_nodes('div.list_content > a' ) %>%
       html_text()
   > news_title
```

<br>

### **✅ 과제3**

```
# 20223015 이정욱 과제3


🔹 패키지 설치 및 불러오기
if(!require(devtools)) {install.packages("devtools"); library(devtools)}
# if(!require(RSelenium)) {install.packages("RSelenium"); library(RSelenium)}
if(!require(rvest)) {install.packages("rvest"); library(rvest)}
if(!require(httr)) {install.packages("httr"); library(httr)}
if(!require(stringr)) {install.packages("stringr"); library(stringr)}
if(!require(dplyr)) {install.packages("dplyr"); library(dplyr)}
__________________________________________________________________________________________

🔹 url생성
   > url1 <- 'https://comic.naver.com/bestChallenge/list?titleId='
   > url2 <- '&page='
   > webtoon_code <- 701701
   > url


🔹 여러페이지 스크래핑 결과 합치기
   > single_webtoon_review_total <- c()


   > for (page in 1:5) {
       url <- paste(url1, webtoon_code, url2, page, sep='')
       url
       html <- url %>%
         read_html
  
  
    #toon_score 가져오기
     > toon_score <- html %>%
         html_nodes ("div.rating_type > strong") %>%
         html_text()
     > toon_score
     > toon_score <- as.numeric(toon_score)
     > toon_score
  
  
    #toon_title가져오기
     > toon_title <- html %>%
         html_nodes("td.title > a") %>%
         html_text()
     > toon_title
  
  
    #loop 설정하기
     > review_one_page <- data.frame(toon_title=toon_title, toon_score=toon_score)
     > str(review_one_page)
     > single_webtoon_review_total <- rbind(single_webtoon_review_total, review_one_page)
   > }  #For Loop 끝


   > str(single_webtoon_review_total)
   > nrow(single_webtoon_review_total)


🔹 PC에 저장하기
   > write.csv(single_webtoon_review_total, "c:/data/webtoon.csv")
```

<br>

### **✅ 기말예시**
```
🔹dplyr 패키지의 이해

# filter
# select
# arrange
# mutate
# group_by
# summarise


data(mtcars)
str(mtcars)
__________________________________________________________________________________________

🔹am 변수 값이 1이면서 mpg가 평균 이상인 자동차의 최대 hp값, 최소 hp 값을 구하는 코드

> library(dplyr)

> my_mtcars <- mtcars %>%
   filter(am==1) %>%
   filter(mpg >= mean(mpg))
> max(my_mtcars)
> min(my_mtcars)


> library(dplyr)
> my_mtcars <- mtcars %>%
   filter(?????) 

  
> max(my_mtcars)
> min(my_mtcars)
__________________________________________________________________________________________

🔹mtcars data에서 am의 종류에 따라 연비(mpg)가 어떻게 달라지는지 mpg의 평균, 최대, 최소, 중앙값을 비교하여 출력하시오.

> mtcars %>%
   group_by(am) %>%
   summarise(mean_mpg = mean(mpg),
             max_mpg = max(mpg),
             min_mpg= min(mpg),
             median_mpg = median(mpg))
__________________________________________________________________________________________

🔹mtcars 데이터에서 평균연비 이상인 차는 '고연비', 이하는 '저연비'라고 저장하는 '연비종류'변수를 생성하시오.

> mtcars %>%
   mutate(연비종류 = ifelse(mpg >= mean(mpg), '고연비', '저연비'))
__________________________________________________________________________________________

🔹네이버 웹툰에서 별점을 스크래핑하는 코드의 일부분이다.  완성하시오.

> url <- 'lieriejioeiower'
> star_score <- url %>%
   read_html() %>%
   html_nodes() %>%
   html_text()  
```